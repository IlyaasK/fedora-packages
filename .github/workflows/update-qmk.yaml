name: Auto-Update QMK Spec

on:
  schedule:
    # Run every day at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows you to click "Run" manually for testing

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest QMK version from PyPI
        id: pypi
        run: |
          # Fetch JSON from PyPI and parse the version
          LATEST_VERSION=$(curl -s https://pypi.org/pypi/qmk/json | jq -r '.info.version')
          echo "Latest version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Read current spec version
        id: spec
        run: |
          # Extract the version number currently in the .spec file
          CURRENT_VERSION=$(grep "Version:" qmk.spec | awk '{print $2}')
          echo "Current spec version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update Spec File
        if: steps.pypi.outputs.version != steps.spec.outputs.version
        run: |
          NEW_VER="${{ steps.pypi.outputs.version }}"
          
          echo "Updating spec from ${{ steps.spec.outputs.version }} to $NEW_VER"
          
          # 1. Update the Version line
          sed -i "s/^Version:        .*/Version:        $NEW_VER/" qmk.spec
          
          # 2. Reset Release to 1
          sed -i "s/^Release:        .*/Release:        1%{?dist}/" qmk.spec
          
          # 3. Add a Changelog entry (Optional but good practice)
          DATE_STR=$(date "+%a %b %d %Y")
          CL_ENTRY="* $DATE_STR GitHub Action <action@github.com> - $NEW_VER-1\n- Automatic update to $NEW_VER"
          
          # Insert the new changelog entry after the %changelog line
          sed -i "/%changelog/a $CL_ENTRY" qmk.spec

      - name: Commit and Push
        if: steps.pypi.outputs.version != steps.spec.outputs.version
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update qmk.spec to version ${{ steps.pypi.outputs.version }}"
          branch: main

      - name: Trigger Copr Build
        if: steps.pypi.outputs.version != steps.spec.outputs.version
        run: |
          # Trigger the webhook to tell Copr to pull the new spec and build
          curl -X POST "${{ secrets.COPR_WEBHOOK }}"
